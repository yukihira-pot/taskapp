{% extends 'main/base.html' %}
{% load static task_app %}
{% load static %}
{% load sass_tags %} 

{% block style %}
<link rel="stylesheet" href="{% sass_src 'main/scss/my-tasks.scss' %}">
{% endblock style %}

{% block header %}{% endblock header %}

{% block content %}

<h2>{{ username }}のタスクリスト</h2>

<div>
    {% if user.icon %}
    <img src="{{ user.icon.url }}" alt="アイコン画像" class="task__icon">
    {% else %}
    <img src="{% static 'main/images/default-icon.png' %}" alt="デフォルトのアイコン画像" class="task__icon">
    {% endif %}
</div>

<img src="{% static 'main/images/settings.png' %}" alt="設定" id="settings-image" onclick="toggleVisibility('settings');">

<div id="settings" style="display: none;">
    <form method="post">
        {% csrf_token %}
        {{ usernamechange_form.as_p }}
        <input type="submit" value="完了">
    </form>
</div>

<h3>新しいタスク</h3>
<form action="{% url 'main:my_tasks' %}" method="post">
    {% csrf_token %}
    {{ task_form.non_field_errors }}
    <div class="form-field">
        {{ task_form.title.label_tag }}
        {{ task_form.title }}
    </div>
    <div class="form-field">
        {{ task_form.content.label_tag }}
        {{ task_form.content }}
    </div>
    <div class="form-field">
        {{ task_form.deadline.label_tag }}
        {{ task_form.deadline }}
    </div>
    <button type="submit">送信</button>
</form>

<h3>タスク一覧</h3>
<div id="my-tasks">
    {% if not my_tasks_list %}
        <p id="task-notset">タスクはまだ設定されていません</p>
    {% else %}
        <p id="task-set">現在のタスク</p>
        {% for task in my_tasks_list %}
            {% if task.is_completed == False %}
                <ul id="task-{{ task.pk }}">
                    <li>タイトル: {{ task.title }}</li>
                    <li>本文: {{ task.content }}</li>

                    {% if task.deadline %}
                        <li>締切: {{ task.deadline }}</li>
                        {% if task.is_deadline_passed %}
                            <li>締切を<b>{{ task.remaining_datetime | deadline_passed_elapsed_time }}</b>過ぎています</li>
                        {% else %}
                            <li>締切まで: {{ task.remaining_datetime | elapsed_time }}</li>
                        {% endif %}
                    {% else %}
                        <li>締切なし</li>
                    {% endif %} {# task.deadline #}

                    <li class="task-complete-delete__container">
                        <form class="task-complete" action="" method="post">
                            {% csrf_token %}
                            <button type="submit" value="{{ task.pk }}" class="task-complete__btn">完了</button>
                        </form>
                    </li>
                    <li class="task-complete-edit__container">
                        <button type="submit" value="{{ task.pk }}" class="task-edit__btn" onclick="toggleVisibility('task-edit__form-{{ task.id }}');">編集</button>
                        <form id="task-edit__form-{{ task.id }}" class="task-edit__form" action="" method="post" style="display: none;">
                            {% csrf_token %}
                            {{ task_form.non_field_errors }}
                            <p>タイトル: <input type="text" name="title" maxlength="256" required="" id="id_title" value="{{ task.title }}"></p>
                            <p>内容: <input type="text" name="content" id="id_content" value="{{ task.content }}"></p>
                            <p>締切: <input type="date" name="deadline_0" value="{{ task.deadline | extract_date_from_datetime }}" required="" id="id_deadline_0">
                            <input type="time" name="deadline_1" value="{{ task.deadline | extract_time_from_datetime }}" required="" id="id_deadline_1"></p>
                            <button type="submit" value="{{ task.pk }}" class="task-edit__submit-btn">変更</button>
                        </form>
                    </li>
                </ul>
            {% endif %}
        {% endfor %}
    {% endif %}    
</div>

{% endblock content %}

{% block script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="{% static 'main/js/my-tasks-popup-settings.js' %}"></script>
<script src="{% static 'main/js/my-tasks-ajax.js' %}"></script>
{% endblock script %}